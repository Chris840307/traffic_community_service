<?php
include "function.php";
$nav="新增案件";
if( $_POST["commit"] == "案件傳送" ) {

$sn_date = str_replace('-','',substr(date("Y-m-d H:i:s"),0,10));
$check_sn = $pdo->query('select * from `cases` where `DetectLocation`="移動式測速" and `sn` like "%'.$sn_date.'%" order by `sn` desc limit 1');
$sn_sum = $check_sn->rowCount();
if( $sn_sum == 0 ) {
	$sn = 'L'.$sn_date.'00001';
} else {
	$row_sn = $check_sn->fetch(PDO::FETCH_ASSOC);
	$sn = 'L'.(substr($row_sn["sn"],1,13)+1);
}
$first_car_number=strtoupper($_POST["doc"]["first_car_number"]);
$last_car_number=strtoupper($_POST["doc"]["last_car_number"]);
$car_max=$_POST["doc"]["car_max"];
$car_real=$_POST["doc"]["car_real"];
$full_car_number=$first_car_number.'-'.$last_car_number;
$car_type_code=$_POST["doc"]["car_type_code"];
$DetectLocation="移動式測速";
if( $_POST["doc"]["area_define"] != "" ) {
$Location=$_POST["doc"]["area_define"];
} else {
$Location=$_POST["doc"]["area_district"];
}
$reason_code=$_POST["doc"]["expose_reason_code"];
$reason_code .= ' ( 限速'.$car_max.'公里, 實際測速'.$car_real.'公里 )。';
$created_at=str_replace('/','-',$_POST["doc"]["violated_at"]).':00';
$state="complete";
$VideoURL="";
$PhotoURL='l/'.date("Y").'/'.date("m").'/'.date("Ym").'/'.$sn.'/'.$full_car_number.'/result.jpg';
$review_user_id=$row_user["name"];
$review_department=$row_user["department"].$row_user["unit"];
$file_no="";
$expose='舉發';
if( $_FILES["doc"]["name"]["doc_attachments_attributes"][0]["file"] != "" ) {
	$allowedTypes = array(IMAGETYPE_PNG, IMAGETYPE_JPEG, IMAGETYPE_GIF);
	$detectedType = exif_imagetype($_FILES['doc']['tmp_name']['doc_attachments_attributes'][0]['file']);
	$error = !in_array($detectedType, $allowedTypes);
	if( $error == "" ) {
		if(!file_exists('../CarSystem/l/'.date("Y")))
			mkdir('../CarSystem/l/'.date("Y"));
		if(!file_exists('../CarSystem/l/'.date("Y").'/'.date("m")))
			mkdir('../CarSystem/l/'.date("Y").'/'.date("m"));	
		if(!file_exists('../CarSystem/l/'.date("Y").'/'.date("m").'/'.date("Ym")))
			mkdir('../CarSystem/l/'.date("Y").'/'.date("m").'/'.date("Ym"));
		if(!file_exists('../CarSystem/l/'.date("Y").'/'.date("m").'/'.date("Ym").'/'.$sn))
		        mkdir('../CarSystem/l/'.date("Y").'/'.date("m").'/'.date("Ym").'/'.$sn);
		if(!file_exists('../CarSystem/l/'.date("Y").'/'.date("m").'/'.date("Ym").'/'.$sn.'/'.$full_car_number))
			mkdir('../CarSystem/l/'.date("Y").'/'.date("m").'/'.date("Ym").'/'.$sn.'/'.$full_car_number);
		move_uploaded_file($_FILES['doc']['tmp_name']['doc_attachments_attributes'][0]['file'], '../CarSystem/l/'.date("Y").'/'.date("m").'/'.date("Ym").'/'.$sn.'/'.$full_car_number.'/result.jpg');
	} else {
		$file_no = 1;
	}
} else {
	$file_no = 1;
}

if( $file_no == "" ) {
	$today_date = date("Y-m-d H:i:s");
$pdo->prepare("INSERT INTO `cases` (`id`, `car_type_code`,`first_car_number`, `last_car_number`, `sn`, `DetectLocation`, `Location`, `reason_code`, `full_car_number`, `VideoURL`, `PhotoURL`, `review_user_id`, `review_department`, `expose`, `state`, `created_at`, `updated_at`,`complete_date`,`car_speed`,`car_speed_max`) VALUES (NULL, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?,?,?,?)")->execute(array($car_type_code,$first_car_number,$last_car_number,$sn,$DetectLocation,$Location,$reason_code,$full_car_number,$VideoURL,$PhotoURL,$review_user_id,$review_department,$expose,$state,$created_at,$created_at,$today_date,$car_real,$car_max));
        echo '<script>document.location.href="cases2.php?DetectLocation=移動式測速&page=1";</script>';
        exit;
} else {
	$error_msg='<font color="red">請上傳一張圖片!</font>';
}	

}

?>
<!DOCTYPE html>
<html lang="zh-cmn-Hant">

<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>新竹市警察局交通違規檢舉系統</title>

  <meta name="csrf-param" content="authenticity_token" />
<meta name="csrf-token" content="dtQ0kLcyBcoTBTfeopTr84sCjzI8L6Vb52QR2RrFbdb/HrWpAx49ZA8tu8Mof/VoQGweX+BmKtHA8TXwslShtw==" />
  

  <link rel="stylesheet" media="all" href="/new/admin/assets/admin-92e995e469ea98c880e61710f498cb7c0dddcd185d591b92bc985fb93e14d29a.css" />

</head>

  <body id="page-top" class="case_wrapper cases index collection">
<?php include "menu.php";?>
    <div id="wrapper">


      <div id="content-wrapper">
        <div class="container-fluid">
          <div class="flashes">
            

          </div>


<!--          <form class="simple_form new_doc" id="new_doc" autocomplete="off" enctype="multipart/form-data" action="cases_w.php" accept-charset="UTF-8" method="post">-->
<div class="card mb-3">

    <div class="card-header">
      <i class="far fa-info-square"></i>
      新增案件
      <div class="float-right">    <a class="btn btn-primary btn-sm" href="cases2.php?DetectLocation=移動式測速&n">回到列表</a>

<span class="divider"></span>
</div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-sm-12">
          
          
          <div class="bgc-white p-20 bd">
            <div class="mT-30">
              
<div class="container">
<div class="col-md-12 case-form" style="margin-top: 15px;">

<form class="simple_form new_case" id="new_case" enctype="multipart/form-data" action="cases_w.php" data-remote="true" method="post">
<input type="hidden" name="email_chk" id="email_chk" value="1">
<div class="form-group row">
      <label class="col-sm-2 col-form-label">案件類別</label>
      <div class="col-sm-10">
        <input type="hidden" name="case[category_name]" value=""><div class="form-check-inline"><input class="form-check-input radio_buttons required" required="required" aria-required="true" type="radio" value="民眾親送" name="case[category_name]" id="case_category_name_民眾親送"><label class="form-check-label collection_radio_buttons" for="case_category_name_民眾親送">民眾親送</label></div><div class="form-check-inline"><input class="form-check-input radio_buttons required" required="required" aria-required="true" type="radio" value="他轄函轉" name="case[category_name]" id="case_category_name_他轄函轉"><label class="form-check-label collection_radio_buttons" for="case_category_name_他轄函轉">他轄函轉</label></div>
      </div>
    </div>
  <div class="bgc-white p-20 bd">
    <div class="mT-30">
      <div class="alert" style="background-color: orange;text-align: center;">
        檢舉人資料
      </div>
      <div class="form-group row">
        <label for="case_email" class="col-sm-2 col-form-label">Email</label>
        <div class="col-sm-10 input-group">
          <input class="form-control string email optional form-control " type="email" name="case[email]" id="case_email" />
          <!--<div class="input-group-append">
            <span class="input-group-text ">
              <a href="javascript:void(0)" class="send_verify_email">驗證</a>
            </span>
          </div>-->
        </div>
      </div>

      <div class="form-group row">
        <label for="case_name" class="col-sm-2 col-form-label">檢舉人姓名</label>
        <div class="col-sm-10 ">
          <input class="form-control string required form-control " required="required" aria-required="true" type="text" name="case[name]" id="case_name" />
        </div>
      </div>
      <div class="form-group row">
        <label for="case_id_number" class="col-sm-2 col-form-label">身分證字號</label>
        <div class="col-sm-10 ">
          <input class="form-control string required form-control " required="required" aria-required="true" type="text" name="case[id_number]" id="case_id_number" />
        </div>
      </div>


      <div class="form-group row">
        <label for="case_contact_address" class="col-sm-2 col-form-label">聯絡地址</label>
        <div class="col-sm-10">
          <input class="form-control string required form-control " required="required" aria-required="true" type="text" name="case[contact_address]" id="case_contact_address" />
        </div>
      </div>

      <div class="form-group row">
        <label for="case_phone" class="col-sm-2 col-form-label">聯絡電話</label>
        <div class="col-sm-10">
          <input class="form-control string required form-control " required="required" aria-required="true" type="text" name="case[phone]" id="case_phone" />
        </div>
      </div>

<div class="form-group row">
      <label class="col-sm-2 col-form-label">檢舉日期／時間</label>
      <div class="col-sm-10">
        <input class="form-control string optional datetimepicker form-control datetimepicker-input is-valid" data-toggle="datetimepicker" data-target="#case_created_at" type="text" name="case[created_at]" id="case_created_at" aria-invalid="false">
      </div>
    </div>

      <div class="alert" style="background-color: orange;text-align: center;">
        檢舉內容
      </div>

<div class="form-group row">
      <label class="col-sm-2 col-form-label">違規日期／時間</label>
      <div class="col-sm-5 col-12">
        <input class="form-control string optional datetimepicker form-control datetimepicker-input is-valid" data-toggle="datetimepicker" data-target="#case_violated_at" type="text" name="case[violated_at]" id="case_violated_at" aria-invalid="false">
      </div>
    </div>

      <div class="form-group row">
        <label for="case_car_type_code" class="col-sm-2 col-form-label">違規車號</label>
        <div class="col-sm-10">
          <div class="row">
            <div class="col-12">
              <select class="form-control select optional form-control  select2" name="case[car_type_code]" id="case_car_type_code"><option value="">請選擇</option>
<?php
$resultc = $pdo->query("SELECT * FROM `car_types` where `active`='t' order by id");
while($rowc = $resultc->fetch(PDO::FETCH_ASSOC)){
echo '<option value="'.$rowc["name"].'">'.$rowc["name"].'</option>';
}
?>
</select>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col-sm-2 col-5">
              <input class="form-control string required form-control" style="text-transform:uppercase" required="required" aria-required="true" placeholder="必填" type="text" name="case[first_car_number]" id="case_first_car_number" />
            </div>
            &mdash;
            <div class="col-sm-2 col-5">
              <input class="form-control string required form-control" style="text-transform:uppercase" required="required" aria-required="true" placeholder="必填" type="text" name="case[last_car_number]" id="case_last_car_number" />
            </div>
          </div>
        </div>
      </div>

      <div class="form-group row">
        <label for="case_area_district" class="col-sm-2 col-form-label">違規地點</label>
        <div class="col-sm-10">
          <div class="row">
            <div class="col-sm-3">
              <select class="form-control select required form-control district  select2" required="required" aria-required="請選擇" name="case[area_district]" id="case_area_district"><option value="">請選擇</option>
</select>
            </div>

            <div class="col-sm-3">
              <select class="form-control select required form-control  select2" required="required" aria-required="請先選取區域" name="case[area_code]" id="case_area_code"><option value="">請先選取區域</option>
</select>

            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div class="col-sm-2 input-group">
              <input class="form-control string optional form-control " type="text" name="case[addr1]" id="case_addr1" />
              <div class="input-group-append">
                <span class="input-group-text ">
                  <label for="case_addr1" > 巷 </label>
                </span>
              </div>
            </div>
            <div class="col-sm-2 input-group">
              <input class="form-control string optional form-control " type="text" name="case[addr2]" id="case_addr2" />
              <div class="input-group-append">
                <span class="input-group-text ">
                  <label for="case_addr2" > 弄 </label>
                </span>
              </div>
            </div>

            <div class="col-sm-2 input-group">
              <input class="form-control string optional form-control " type="text" name="case[addr3]" id="case_addr3" />
              <div class="input-group-append">
                <span class="input-group-text ">
                  <label for="case_addr3" > 號 </label>
                </span>
              </div>
            </div>

            <div class="col-sm-2 input-group">
              <input class="form-control string optional form-control " type="text" name="case[addr4]" id="case_addr4" />
              <div class="input-group-append">
                <span class="input-group-text ">
                  <label for="case_addr4" > 之號 </label>
                </span>
              </div>
            </div>

            <div class="col-sm-2 input-group">
              <input class="form-control string optional form-control " type="text" name="case[addr5]" id="case_addr5" />
              <div class="input-group-append">
                <span class="input-group-text ">
                  <label for="case_addr5" > 公里 </label>
                </span>
              </div>
            </div>
          </div>

          <div class="row" style="margin-top: 10px;">
            <div class="col-sm-12">
              <small class="form-text text-muted alert alert-info">
                <label for="case_addr_detail" > 選擇區域及路段後，若無法於上述欄位填寫詳細地址(巷、弄、號、KM等)，請於此欄位填寫說明(如
匝道口、隧道東往西出口、高架橋南往北方向等)。
                </label>
              </small>
              <input class="form-control string optional form-control " placeholder="選填，地點備註，最多50個字" type="text" name="case[addr_detail]" id="case_addr_detail" />

            </div>
          </div>
        </div>
      </div>

      <div class="form-group row">
        <label for="case_illegality_code" class="col-sm-2 col-form-label">違規事實</label>
        <div class="col-sm-10">
          <select class="form-control select required form-control  select2" required="required" aria-required="請選擇" name="case[illegality_code]" id="case_illegality_code"><option value="">請選擇</option>
<option value="50">在多車道右轉彎，不先駛入外側車道，或多車道左轉彎，不先駛入內側車道</option>
<option value="51">道路設有劃分島，劃分快、慢車道，在慢車道上左轉彎或在快車道右轉彎</option>
<option value="52">設有左、右轉彎專用車道之交岔路口，直行車佔用最內側或最外側或專用車道</option>
<option value="16">於身心障礙專用車位違規停車、違規併排停車</option>
<option value="14">於交岔路口、公共汽車招呼站十公尺內或消防車出入口五公尺臨時停車、併排臨停</option>
<option value="17">所載貨物滲漏、飛散、脫落、掉落</option>
<option value="53">載運人客、貨物不穩妥，行駛時顯有危險</option>
<option value="54">車輛機件、設備、附著物不穩妥或脫落</option>
<option value="55">行駛快速公路不依規定使用燈光(含方向燈)</option>
<option value="56">行近未設行車管制號誌之行人穿越道，不減速慢行</option>
<option value="57">起駛前不讓行進中之車輛、行人優先通行</option>
<option value="58">聞消防車、救護車、警備車、工程救險車、毒性化學物質災害事故應變車之警號，在後跟隨急駛，或駛過在救火時放置於路上之消防
水帶</option>
<option value="59">倒車前未顯示倒車燈光，或倒車時不注意其他車輛或行人</option>
<option value="60">大型汽車無人在後指引時，不先測明車後有足夠之地位，或促使行人避讓</option>
<option value="61">在橋樑、隧道、圓環、障礙物對面、人行道、行人穿越道、快車道違規臨時停車</option>
<option value="62">於交岔路口、公共汽車招呼站十公尺內、消防車出入口五公尺之處所違規臨時停車</option>
<option value="63">不依順行方向臨時停車</option>
<option value="64">違規併排臨時停車</option>
<option value="65">在橋樑、隧道、圓環、障礙物對面、人行道、行人穿越道、快車道違規停車</option>
<option value="66">於交岔路口、公共汽車招呼站十公尺內、消防車出入口五公尺之處所違規停車</option>
<option value="67">在機場、車站、碼頭、學校、娛樂、展覽、競技、市場、或其他公共場所出、入口或消防栓之前停車</option>
<option value="68">佔用身障停車格</option>
<option value="69">違規併排停車</option>
<option value="1">違規臨時停車</option>
<option value="2">違規停車</option>
<option value="3">變換車道未使用方向燈</option>
<option value="4">轉彎未使用方向燈</option>
<option value="5">闖紅燈</option>
<option value="6">紅燈時佔用機車停等區</option>
<option value="7">紅燈越線</option>
<option value="8">機車行駛禁行車道</option>
<option value="9">汽車行駛機(慢)車專用道</option>
<option value="10">跨越雙白線行駛</option>
<option value="11">跨越雙黃線行駛</option>
<option value="12">違規左右轉</option>
<option value="13">其他</option>
<option value="15">交岔路口、公共汽車招呼站十公尺內或消防車出入口五公尺禁止停車處所違規停車</option>
<option value="18">未戴安全帽</option>
<option value="19">駕駛人於行駛道路手持行動電話</option>
<option value="20">點燃香菸駕駛</option>
<option value="21">行駛快速公路未保持安全距離</option>
<option value="29">行駛快速公路連續按鳴喇叭、變換燈光或其他方式迫使前車讓道</option>
<option value="49">不遵守道路交通標誌標線號誌指示(如紅燈越線、汽車占用機車停等區)</option>
<option value="38">跨越車道逆向(如駛入來車道)</option>
<option value="37">不按遵行之方向行駛</option>
<option value="27">行駛快速公路未依標誌標線號誌行車</option>
<option value="25">行駛快速公路未依規定使用路肩</option>
<option value="45">不依標誌標線號誌轉彎或變換車道</option>
<option value="22">行駛快速公路違規使用車道</option>
<option value="24">行駛快速公路超車(迴車、倒車、逆向)</option>
<option value="26">行駛快速公路裝載貨物未覆蓋捆紮</option>
<option value="28">快速公路行駛禁行路段</option>
<option value="30">快速公路丟棄物品</option>
<option value="31">行駛快速公路車輪等脫落</option>
<option value="32">違規進入快速公路</option>
<option value="33">快速公路汽缸排氣量550立方公分以上大型重機違規行駛(含同車道併駛、超車、未依規定使用路肩，或未依規定戴安全帽等</option>
<option value="34">一般道路不依規定使用燈光(如方向燈)</option>
<option value="35">危險駕駛(蛇行、迫近驟然變換車道逼車、於車道驟然暫停、二車以上競駛競技)</option>
<option value="36">車不讓人、車不讓視障者</option>
<option value="39">多車道未依規定駕車</option>
<option value="40">行駛人行道</option>
<option value="41">機車不依規定車道行駛</option>
<option value="42">占用自行車專用道</option>
<option value="43">未依規定避讓(警備車、消防車等)</option>
<option value="44">違規超車</option>
<option value="46">違規迴車</option>
<option value="47">闖紅燈</option>
<option value="48">違規行駛鐵路平交道</option>
<option value="23">行駛快速公路不依規定變換車道</option>
<option value="70">不注意來往行人，或轉彎前未減速慢行</option></select>
        </div>
      </div>


      <div class="form-group row illegality_details_filed hide">
        <label for="illegality" class="col-sm-2 col-form-label">違規事實說明</label>
        <div class="col-sm-10 ">
          <input class="form-control string optional form-control " type="text" name="case[illegality_details]" id="case_illegality_details" />
        </div>
      </div>



      <div class="form-group row case_attachments">
        <label for="case_attachment_fields" class="col-sm-2 col-form-label">上傳檔案</label>
        <div class="col-sm-10">
            <label for="case_case_attachments_attributes_0_file"> 檔案 1 </label>

            <div class="nested_case_attachment_inputs custom-file" style="margin-left: 14px;margin-bottom: 14px;">
  <div class="row">
    <div class="col-10">


      <input class="form-control-file file required form-control custom-file-input case_attachment_input form-control-sm" autocomplete="off" onchange="Filevalidation()" accept="image/*, video/*" required="required" aria-required="true" type="file" name="case[case_attachments_attributes][0][file]" id="case_case_attachments_attributes_0_file" />
      <label class="custom-file-label file-label-0" for="customFile">
        選擇檔案
      </label>
      <input class="case_attachment_cache" data-file-size="0" type="hidden" name="case[case_attachments_attributes][0][file_cache]" id="case_case_attachments_attributes_0_file_cache" />
    </div>
    <div class="col-2 clear-file-btn">
      <a href="javascript:void(0)" onclick="clear_file_input(0)" ><i class="fas fa-trash-alt"></i> <label for="clear_file_input(0)">清除</label></a>
    </div>
  </div>
</div>



            <label for="case_case_attachments_attributes_1_file"> 檔案 2 </label>

            <div class="nested_case_attachment_inputs custom-file" style="margin-left: 14px;margin-bottom: 14px;">
  <div class="row">
    <div class="col-10">
      <input class="form-control-file file required form-control custom-file-input case_attachment_input form-control-sm" autocomplete="off" onchange="Filevalidation()" accept="image/*, video/*" required="required" aria-required="true" type="file" name="case[case_attachments_attributes][1][file]" id="case_case_attachments_attributes_1_file" />
      <label class="custom-file-label file-label-1" for="customFile">
        選擇檔案
      </label>
      <input class="case_attachment_cache" data-file-size="0" type="hidden" name="case[case_attachments_attributes][1][file_cache]" id="case_case_attachments_attributes_1_file_cache" />
    </div>
    <div class="col-2 clear-file-btn">
      <a href="javascript:void(0)" onclick="clear_file_input(1)" ><i class="fas fa-trash-alt"></i> <label for="clear_file_input(1)">清除</label></a>
    </div>
  </div>
</div>



            <label for="case_case_attachments_attributes_2_file"> 檔案 3 </label>

            <div class="nested_case_attachment_inputs custom-file" style="margin-left: 14px;margin-bottom: 14px;">
  <div class="row">
    <div class="col-10">


      <input class="form-control-file file required form-control custom-file-input case_attachment_input form-control-sm" autocomplete="off" onchange="Filevalidation()" accept="image/*, video/*" required="required" aria-required="true" type="file" name="case[case_attachments_attributes][2][file]" id="case_case_attachments_attributes_2_file" />
      <label class="custom-file-label file-label-2" for="customFile">
        選擇檔案
      </label>
      <input class="case_attachment_cache" data-file-size="0" type="hidden" name="case[case_attachments_attributes][2][file_cache]" id="case_case_attachments_attributes_2_file_cache" />
    </div>
    <div class="col-2 clear-file-btn">
<a href="javascript:void(0)" onclick="clear_file_input(2)" ><i class="fas fa-trash-alt"></i> <label for="clear_file_input(2)">清除</label></a>
    </div>
  </div>
</div>



            <label for="case_case_attachments_attributes_3_file"> 檔案 4 </label>

            <div class="nested_case_attachment_inputs custom-file" style="margin-left: 14px;margin-bottom: 14px;">
  <div class="row">
    <div class="col-10">


      <input class="form-control-file file required form-control custom-file-input case_attachment_input form-control-sm" autocomplete="off" onchange="Filevalidation()" accept="image/*, video/*" required="required" aria-required="true" type="file" name="case[case_attachments_attributes][3][file]" id="case_case_attachments_attributes_3_file" />
      <label class="custom-file-label file-label-3" for="customFile">
        選擇檔案
      </label>
      <input class="case_attachment_cache" data-file-size="0" type="hidden" name="case[case_attachments_attributes][3][file_cache]" id="case_case_attachments_attributes_3_file_cache" />
    </div>
    <div class="col-2 clear-file-btn">
      <a href="javascript:void(0)" onclick="clear_file_input(3)" ><i class="fas fa-trash-alt"></i> <label for="clear_file_input(3)">清除</label></a>
    </div>
  </div>
</div>



            <label for="case_case_attachments_attributes_4_file"> 檔案 5 </label>
            <div class="nested_case_attachment_inputs custom-file" style="margin-left: 14px;margin-bottom: 14px;">
  <div class="row">
    <div class="col-10">


      <input class="form-control-file file required form-control custom-file-input case_attachment_input form-control-sm" autocomplete="off" onchange="Filevalidation()" accept="image/*, video/*" required="required" aria-required="true" type="file" name="case[case_attachments_attributes][4][file]" id="case_case_attachments_attributes_4_file" />
      <label class="custom-file-label file-label-4" for="customFile">
        選擇檔案
      </label>
      <input class="case_attachment_cache" data-file-size="0" type="hidden" name="case[case_attachments_attributes][4][file_cache]" id="case_case_attachments_attributes_4_file_cache" />
    </div>
    <div class="col-2 clear-file-btn">
      <a href="javascript:void(0)" onclick="clear_file_input(4)" ><i class="fas fa-trash-alt"></i> <label for="clear_file_input(4)">清除</label></a>
    </div>
  </div>
</div>

          <p class="text-right">
            <span class="text-danger">檔案大小總和: <span class="filesize">0&nbsp;</span>MB</span>
          </p>
          <small class="form-text text-muted alert alert-info">支援檔案類型：<br/>
          圖片: jpg,jpeg,png,bmp,gif,tiff<br/>
          影片: wmv,avi,mp4,mov<br/>
          每案上傳總容量限制為 80MB，如您係以<span class="text-danger">影片檢舉交通違規，請您擷取檢舉之違規片段即可，以避免影片容量過大
無法上傳。</span>
          </small>
        </div>
      </div>
      <!--<div class="form-group row">
        <div class="custom-control custom-checkbox">
          <input name="case[read_statement]" type="hidden" value="0" /><input class="form-check-input boolean optional custom-control-input" type="checkbox" value="1" name="case[read_statement]" id="case_read_statement" />
          <label for="case_read_statement" class="custom-control-label"><p class="text-danger">(必填)</p>我已閱讀並同意新竹市警察局<a href="http://www2.hccp.gov.tw/hccp/personal_information2.asp" title="個人資料收集聲明及服務條款">【個人資料收集聲明及服務條款】</a>暨相>關<a href="http://www2.hccp.gov.tw/hccp/privacy.asp" title="隱私權政策">【隱私權政策】</a>
            <br/>經確認所有檢舉資料皆為真實，若相關資料(照片、車號及違規時間等) ，經查證為不實或偽造之違法行為，願負起相關民事或刑事責>任</label>
        </div>
      </div>-->

<div class="row justify-content-md-center justify-content-center" style="margin: 0px auto; line-height: 23px; font-size: 18px;">
      <a class="btn btn-lg btn-success preview_btn" onclick="preview()" data-remote="true" href="#">預覽</a>
      <input type="submit" name="commit" value="預覽" class="btn btn btn-lg btn-success hide" data-disable-with="預覽">
      <input type="submit" name="commit" value="submit" class="btn case_submit hide" data-disable-with="submit">
    </div>

      <!--<div class="row justify-content-md-center justify-content-center" style="margin: 0px auto; line-height: 23px; font-size: 18px;">
        <a class="btn btn-lg btn-success preview_btn disabledd" onclick="preview()" data-remote="true" href="#">預覽</a>
        <input type="submit" name="commit" value="預覽" class="btn btn btn-lg btn-success hide" disabled="disabled" data-disable-with="預覽" />
        <input type="submit" name="commit" value="submit" class="btn case_submit hide" data-disable-with="submit" />
      </div>-->
    </div>
  </div>

</form>
</div>
</div>
<div class="modal" id="case_preview" data-backdrop="static">

</div>

</div></div></div></div>
</div>


        </div>
        <!-- /.container-fluid -->

        <!-- Sticky Footer -->
        <footer class="sticky-footer">
          <div class="container my-auto">
            <div class="copyright text-center my-auto">
              <span>新竹市警察局交通違規檢舉系統</span>
            </div>
          </div>
        </footer>

      </div>
      <!-- /.content-wrapper -->

    </div>


<script src="/new/admin/assets/admin-7e641842b7678866dba9f029b1984fc78978fbe3c300f84802bb98e82b1f6905.js"></script>
    <script type="text/javascript">
    $(function(){
      $('input[name="agree"]').change(function() {
        if($(this).is(':checked')){
          $('.submit_statement').removeAttr('disabled')
        }else{
          $('.submit_statement').attr('disabled', 'disabled')
        }
      });
    })
    $(window).on('load',function(){
	    $('input[name="commit"]').removeAttr('disabled')
	    $('.preview_btn').removeClass('disabled')
        //$('#exampleModalCenter').modal('show');
    });
  </script>

<style type="text/css">



  footer{
    position: absolute;
    bottom: 0;
    width: 100%;
    clear:both;
    /*background-color: #E5E4E2;*/
  }
  footer p{
    color: #000;
    font-size: 14px;
  }

  *{
    margin: 0; padding: 0
  };
  html,body{
    height: 100%;
  };



</style>


    <script type="text/javascript">
    $(function() {
      $( ".select2" ).select2({
  theme: "bootstrap",
  language: "zh-TW"
});

$('.select2').change(function(){
  if($(this).valid() == true){

  }
});



$('form').find(".is-invalid:first").focus();


$('select.form-control.is-invalid.select2').each(function(){
  $(this).siblings('.select2-container').find(".select2-selection").addClass('is-invalid')
});

Filevalidation();
$('.invalid-feedback').each(function(){
  if($(this).next().hasClass('input-group-append')){
    $(this).next().after($(this));
  }
})
$(".custom-file-input").on("change", function() {
  var fileName = $(this).val().split("\\").pop();
  $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
});

var namespace = "cases"

if(namespace != 'admin'){
  if($('input[name="case[read_statement]"]').is(':checked')){
    $('input[name="commit"]').removeAttr('disabled')
    $('.preview_btn').removeClass('disabled')
  }else{
      $('input[name="commit"]').removeAttr('disabled')
      $('.preview_btn').removeClass('disabled')
    //$('input[name="commit"]').attr('disabled', 'disabled')
    //$('.preview_btn').addClass('disabled')
  }

  $('input[name="case[read_statement]"]').change(function() {
    if($(this).is(':checked')){
      $('input[name="commit"]').removeAttr('disabled')
      $('.preview_btn').removeClass('disabled')
    }else{
      $('input[name="commit"]').attr('disabled', 'disabled')
      $('.preview_btn').addClass('disabled')
    }
  });
}

$("#case_illegality_code option").each(function() {
if( $(this).val() == "1" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "2" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "3" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "4" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "5" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "6" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "7" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "8" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "9" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "10" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "11" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "12" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "13" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "14" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "15" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "16" ){
$(this).wrap('<span/>');
}
if( $(this).val() == "31" ){
$(this).wrap('<span/>');
}
});

$('select[name="case[illegality_code]"]').change(function () {
  $('.illegality_details_filed').val('');
  //alert(JSON.stringify($(this).val()))
  //if($(this).val() == "13"){
  //  $('.illegality_details_filed').removeClass('hide')
  //}else{
  //  $('.illegality_details_filed').addClass('hide')
  //}
  $('.illegality_details_filed').addClass('hide')
});


var datas = {"東區":[["台68線(東區)","D0002"],["八德路","A0001"],["三民路","A0010"],["千甲路","A0011"],["大同路","A0012"],["大成街","A0013"],["大學路","A0014"],["公道五路一段","A0021"],["中央路","A0022"],["中正路","A0023"],["中南街","A0024"],["中華路一段","A0025"],["中華路二段","A0026"],["仁愛街","A0027"],["仁義街","A0028"],["介壽路","A0029"],["公園路","A0030"],["公道五路二段","A0031"],["公道五路三段","A0032"],["太原路","A0033"],["文化街","A0034"],["文昌街","A0035"],["水利路","A0037"],["水源街","A0038"],["世界街","A0039"],["世傑路","A0040"],["北大路","A0041"],["占梅路","A0042"],["四維路","A0043"],["平和街","A0044"],["民主路","A0045"],["民生路","A0046"],["民有一街","A0047"],["民有二街","A0048"],["民有街","A0049"],["民享一街","A0050"],["民享街","A0051"],["民治街","A0052"],["民族路","A0053"],["民權路","A0054"],["田美一街","A0055"],["田美二街","A0056"],["田美三街","A0057"],["立鵬路","A0058"],["仲生路","A0059"],["仰德路","A0060"],["光明新村","A0061"],["光復路一段","A0062"],["光復路二段","A0063"],["光復路二段清大西院","A0064"],["光復路二段清大東院","A0065"],["光華東街","A0066"],["光華南街","A0067"],["光華街","A0068"],["安和街","A0069"],["安康街","A0070"],["安富街","A0071"],["竹蓮街","A0077"],["自由路","A0078"],["西大路","A0079"],["西門街","A0080"],["志平路","A0081"],["育民街","A0082"],["府後街","A0083"],["忠孝路","A0084"],["明湖路","A0085"],["東大路一段","A0086"],["東大路二段","A0087"],["東山街","A0088"],["東光路","A0089"],["東明街","A0090"],["東門市場","A0091"],["東門街","A0092"],["東前街","A0093"],["東南街","A0094"],["東美路","A0095"],["東勝路","A0096"],["東進路","A0097"],["東勢街","A0098"],["東園街","A0099"],["林森路","A0100"],["武昌街","A0101"],["花園街","A0102"],["花園新城街","A0103"],["金山一街","A0104"],["金山二街","A0105"],["金山三街","A0106"],["金山五街","A0107"],["金山六街","A0108"],["金山七街","A0109"],["金山八街","A0110"],["金山九街","A0111"],["金山十街","A0112"],["金山十一街","A0113"],["金山十二街","A0114"],["金山十三街","A0115"],["金山十五街","A0116"],["金山十六街","A0117"],["金山十七街","A0118"],["金山十八街","A0119"],["金山十九街","A0120"],["金山二十街","A0121"],["金山二十一街","A0122"],["金山二十二街","A0123"],["金山二十三街","A0124"],["金山二十五街","A0125"],["金山二十六街","A0126"],["金山二十七街","A0127"],["金山二十八街","A0128"],["金山北一街","A0129"],["金山北二街","A0130"],["金山北三街","A0131"],["金山東一街","A0132"],["金山東二街","A0133"],["金山東三街","A0134"],["金山東街","A0135"],["金山街","A0136"],["金城一路","A0137"],["金城二路","A0138"],["長春街","A0139"],["信義街","A0140"],["南大路","A0141"],["南外街","A0142"],["南門街","A0143"],["南城街","A0144"],["建中一路","A0145"],["建中路","A0146"],["建功一路","A0147"],["建功二路","A0148"],["建功路","A0149"],["建美路","A0150"],["建華街","A0151"],["建新路","A0152"],["柏川一路","A0153"],["柏川二路","A0154"],["柏川三路","A0155"],["科學園路","A0166"],["風空街","A0167"],["食品路","A0168"],["原興路","A0169"],["埔頂一路","A0170"],["埔頂二路","A0171"],["埔頂三路","A0172"],["埔頂路","A0173"],["振興一街","A0176"],["振興路","A0177"],["柴橋路","A0178"],["草湖街","A0179"],["高峰路","A0180"],["高翠路","A0181"],["國華街","A0182"],["培英街","A0183"],["崇和路","A0184"],["勝利路","A0186"],["博愛街","A0187"],["復興路","A0188"],["惠民街","A0189"],["湖濱一路","A0190"],["湖濱二路","A0191"],["湖濱三路","A0192"],["園後街","A0193"],["園區二路356巷口(新竹市轄)","A0195"],["慈祥路","A0197"],["慈雲路","A0198"],["慈濟路","A0199"],["愛民街","A0200"],["新光路","A0201"],["新香街","A0203"],["新莊街","A0204"],["新源街","A0205"],["溪州路","A0206"],["溪埔路","A0207"],["瑞麟路","A0208"],["經國路一段","A0209"],["裕民街","A0210"],["福德街","A0211"],["綠水路","A0212"],["德成街","A0213"],["德高街","A0214"],["學府路","A0215"],["澤藩路","A0216"],["興中街","A0219"],["興竹街","A0220"],["興達街","A0222"],["興學街","A0223"],["錦華街","A0224"],["龍山西路","A0225"],["龍山東一街","A0226"],["龍山東路","A0227"],["藝術路","A0228"],["關東路","A0229"],["關新一街","A0230"],["關新二街","A0231"],["關新北路","A0232"],["關新西街","A0233"],["關新東路","A0234"],["關新路","A0235"],["寶山路","A0236"],["鐵道路一段","A0237"],["鐵道路二段","A0238"],["體育街","A0239"],["赤土崎一街","A0240"],["赤土崎二街","A0242"],["金山南街","A0243"],["東新路","A0244"],["東竹路","A0245"],["金城三路","A0246"],["新科一街","A0247"],["客雅大道","A0248"],["公竹路","A0249"],["金山忠街","A250"]],"北區":[["台68線(北區)","D0001"],["大同路","B0001"],["中山路","B0002"],["中央路","B0003"],["中正路","B0004"],["中光路","B0005"],["中和路","B0006"],["中清一路","B0007"],["中清路","B0008"],["中清路一段","B0009"],["中華路二段","B0010"],["中華路三段","B0011"],["中福路","B0012"],["中興路","B0013"],["仁化街","B0014"],["仁和路","B0015"],["仁德街","B0016"],["公道五路四段","B0017"],["公道五路五段","B0018"],["天府路一段","B0019"],["天府路二段","B0020"],["少年街","B0021"],["文雅街","B0022"],["水田街","B0023"],["世界街","B0024"],["北大路","B0025"],["北門街","B0026"],["北新街","B0027"],["古賢","B0028"],["四維路","B0029"],["平和街","B0030"],["民富街","B0031"],["田美三街","B0032"],["石坊街","B0033"],["光華一街","B0034"],["光華二街","B0035"],["光華北街","B0036"],["光華東一街","B0037"],["光華東街","B0038"],["光華南街","B0039"],["光華街","B0040"],["吉羊路","B0041"],["成功路","B0042"],["成德一街","B0043"],["成德二街","B0044"],["成德路","B0045"],["江山街","B0046"],["竹文街","B0047"],["竹光路","B0048"],["西大路","B0049"],["西安街","B0050"],["西門街","B0051"],["西濱路一段","B0052"],["孝賢路","B0053"],["育英路","B0054"],["和平路","B0055"],["和福街","B0056"],["尚濱路","B0057"],["府後街","B0058"],["延平路一段","B0059"],["延平路三段","B0060"],["延濱路","B0061"],["忠信路","B0062"],["東大路二段","B0063"],["東大路三段","B0064"],["東大路四段","B0065"],["東門街","B0066"],["東濱街","B0067"],["林森路","B0068"],["武勇街","B0069"],["武陵西二路","B0070"],["武陵西三路","B0071"],["武陵西四路","B0072"],["武陵路","B0073"],["河北街","B0074"],["金竹路","B0075"],["金雅一街","B0076"],["金雅二街","B0077"],["金雅三街","B0078"],["金雅五街","B0079"],["金雅西街","B0080"],["金雅路","B0081"],["金農路","B0082"],["長安街","B0083"],["長和街","B0084"],["南大路","B0085"],["南勢二街","B0086"],["南勢六街","B0087"],["南勢八街","B0088"],["南勢十街","B0089"],["南勢十二街","B0090"],["南勢街","B0091"],["南寮街","B0092"],["城北街","B0093"],["建台街","B0094"],["建國街","B0095"],["建興街","B0096"],["英明街","B0097"],["凌雲街","B0098"],["海濱路","B0099"],["草湖街","B0100"],["國光街","B0101"],["國華街","B0102"],["崧嶺路","B0103"],["勝利路","B0104"],["富美路","B0105"],["港北一街","B0106"],["港北二街","B0107"],["港北三街","B0108"],["港北六街","B0109"],["集和街","B0110"],["集福街","B0111"],["集賢街","B0112"],["湳中街","B0113"],["湳雅街","B0114"],["愛文街","B0115"],["愛國路","B0116"],["新民街","B0117"],["新香街","B0118"],["新港三路","B0119"],["新港北路","B0120"],["新港南路","B0121"],["經國路一段","B0122"],["經國路二段","B0123"],["聖軍路","B0124"],["嘉濱路","B0125"],["境福街","B0126"],["榮濱南路","B0127"],["榮濱路","B0128"],["演藝路","B0129"],["廣州街","B0130"],["德成街","B0131"],["磐石路","B0132"],["衛民街","B0133"],["興南街","B0134"],["興濱路","B0135"],["聯興路","B0136"],["警光路","B0137"],["鐵道路二段","B0138"],["鐵道路三段","B0139"],["士林東路","B0140"],["士林西路","B0141"],["士林北路","B0142"],["士林一街","B0143"],["士林二街","B0144"],["新港四路","B0145"],["金雅八街","B0146"],["金雅東街","B0148"],["金雅七街","B0147"],["金雅六街","B0149"],["台61西濱快速公路","B0150"],["公道三路","B0151"],["南寮大道","B0152"],["仁愛街","B0153"],["大雅路","B0154"]],"香山區":[["大湖路","C0001"],["大庄路","C0002"],["中山路","C0003"],["中華路四段","C0004"],["中華路五段","C0005"],["中華路六段","C0006"],["五福路一段","C0007"],["五福路二段","C0008"],["元培街","C0009"],["內湖路","C0010"],["牛埔北路","C0011"],["牛埔東路","C0012"],["牛埔南路","C0013"],["牛埔路","C0014"],["古車路","C0015"],["玄奘路","C0016"],["竹香北路","C0017"],["竹香南路","C0018"],["至善街","C0019"],["西濱路二段","C0020"],["西濱路三段","C0021"],["西濱路四段","C0022"],["西濱路六段","C0023"],["吳厝街","C0024"],["育德街","C0025"],["那魯灣街","C0026"],["延平路二段","C0027"],["明德路","C0028"],["東香東街","C0029"],["東香南街","C0030"],["東香路一段","C0031"],["東香路二段","C0032"],["東華路","C0033"],["芝柏一街","C0034"],["芝柏二街","C0035"],["芝柏三街","C0036"],["芝柏五街","C0037"],["花園新城一街","C0038"],["花園新城二街","C0039"],["虎林街","C0040"],["長福街","C0041"],["長興街","C0042"],["南港街","C0043"],["南湖路","C0044"],["南隘路一段","C0045"],["南隘路二段","C0046"],["柯湳一街","C0047"],["柯湳二街","C0048"],["美山路","C0049"],["美之城","C0050"],["美之城一街","C0051"],["美森街","C0052"],["茄苳北街","C0053"],["茄苳東街","C0054"],["茄苳路","C0055"],["香北一路","C0056"],["香北路","C0057"],["香村路","C0058"],["香檳一街","C0059"],["香檳二街","C0060"],["香檳三街","C0061"],["香檳五街","C0062"],["香檳東街","C0063"],["香檳南街","C0064"],["埔前路","C0065"],["宮口街","C0066"],["柴橋路","C0067"],["浸水北街","C0068"],["浸水南街","C0069"],["浸水街","C0070"],["浸樹街","C0071"],["海山港十街","C0072"],["海山港路","C0073"],["海埔一街","C0074"],["海埔二街","C0075"],["海埔三街","C0076"],["海埔五街","C0077"],["海埔路","C0078"],["草漯街","C0079"],["國中街","C0080"],["崧嶺路","C0081"],["彩虹路","C0082"],["祥園街","C0083"],["莊敬街","C0084"],["頂美街","C0085"],["頂埔路","C0086"],["富群街","C0087"],["富禮街","C0088"],["景觀大道","C0089"],["港南一街","C0090"],["港南二街","C0091"],["港南三街","C0092"],["港南五街","C0093"],["華北路","C0094"],["華江街","C0095"],["閑谷一街","C0096"],["閑谷二街","C0097"],["閑谷街","C0098"],["新香街","C0099"],["瑞光街","C0100"],["經國路三段","C0101"],["遊樂街","C0102"],["福樹街","C0103"],["墩豐路","C0104"],["樹下街","C0105"],["麗山街","C0106"],["草原路","C0107"],["公道三路","C0108"],["西濱路五段","C0109"],["台61西濱快速公路","C0110"],["三姓橋路","C0111"]]};
var attrs = jQuery.parseJSON('{"id":null,"email":null,"name":null,"id_number":null,"contact_address":null,"phone":null,"created_at":null,"updated_at":null,"addr1":null,"addr2":null,"addr3":null,"addr4":null,"addr5":null,"area_code":null,"illegality_code":null,"illegality_details":null,"car_type_code":null,"first_car_number":null,"last_car_number":null,"sn":null,"area_district":null,"addr_detail":null,"violated_at":null,"real_ip":null,"read_statement":null,"state":"ready","department_id":null,"approve_admin_user_id":null,"review_admin_user_id":null,"recheck_admin_user_id":null,"finish_admin_user_id":null,"expose":false,"expose_reason_code":null,"unexpose_reason_id":null,"unexpose_reason_note":null,"fake":false,"full_car_number":null,"finished_date":null,"comment":null,"reassign_count":0,"category_name":null,"created_admin_user_id":null,"violated_at_date":null,"violated_at_hour":null,"violated_at_min":null}')
var select = $('select.district');
select.change(function () {
  var streets = datas[$(this).val()];
  $('select[name="case[area_code]"]').empty();
  // $('<option>' + '區' + '</option>').appendTo('select[name="case[area_code]"]');
  $('<option value>' + '請輸入關鍵字搜尋' + '</option>').appendTo('select[name="case[area_code]"]');
  $.each(streets, function(index,item) {
    $('<option value=' + item[1] + '>' + item[0] + '</option>').appendTo('select[name="case[area_code]"]');
  });
});
// $('select.district option').remove();
// $('<option>' + '路名' + '</option>').appendTo('select[name="case[area_code]"]');
// $('<option>' + '區' + '</option>').appendTo('select[name="case[area_code]"]');
$.each(datas, function (key, value) {
  $('<option value="' + key + '">' + key + '</option>').appendTo(select);
});

if(!isEmpty(attrs['area_district'])){
  select.val(attrs['area_district']).change();
}


var pro = $('select.district').val();

var streets = datas[pro];

// $('select[name="case[area_code]"] option').remove();
$.each(streets, function(index, item) {
  $('<option value=' + item[1] + '>' + item[0] + '</option>').appendTo('select[name="case[area_code]"]');
});
setTimeout(function(){
  if(!isEmpty(attrs['area_code'])){
    $('select[name="case[area_code]"]').val(attrs['area_code']).change();
  }
}, 1000);




  $(".send_verify_email").click(function(){
    // var reg = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/

    var reg = /\S+@\S+\.\S+/
    var email = $('input[name="case[email]"]').val()
    var name = $('input[name="case[name]"]').val()
    var id_number = $('input[name="case[id_number]"]').val()
    if(reg.test(email)){
      $.post( "s_v_e.php", { email: email, name: name, id_number: id_number },function(resultt){
              if( resultt == "1" ) {
                        $('.send_verify_email').html('已驗證通過');
                        $('.send_verify_email').attr('disabled', 'disabled');
                        $('.send_verify_email').append()
                        $('.send_verify_email').addClass('disabled');
                        $('#email_chk').val('1');
              }
              if( resultt == "2" ) {
                        $('.send_verify_email').html('請收信驗證');
                        $('.send_verify_email').attr('disabled', 'disabled');
                        $('.send_verify_email').append()
                        $('.send_verify_email').addClass('disabled');
                        $('#email_chk').val('0');
              }
      })
      setTimeout(function(){
        $('.send_verify_email').text('驗證')
        $('.send_verify_email').removeClass('disabled')
        clearInterval(i)
      }, 5 * 60 * 1000);

    }else{
      toastr.error('輸入正確的Email地址');
    }
  });
validate_form();

      var format = 'YYYY/MM/DD HH:mm';
      $('.datetimepicker').each(function(i, e){
        var picker = $(e);
        var date = moment(picker.val(), format).toDate();
        var tomorrow = moment(new Date()).add(1,'days').format("YYYY-MM-DD")
        picker.datetimepicker({format: format, date: null, maxDate: tomorrow});
        picker.datetimepicker('date', date);
      })


$('form').on('cocoon:after-insert', function() {
  check_to_hide_or_show_add_link();
});

$('form').on('cocoon:after-remove', function() {
  check_to_hide_or_show_add_link();
});

$('.nested-fields').each(function() {
  $(this).insertBefore($(this).parent());
})
check_to_hide_or_show_add_link();
assign_attrs();


    })
    $(window).on('load',function(){
    });
    function clear_file_input(t){
  var f_input = $('input[name="case[case_attachments_attributes][' + t + '][file]"]')
  f_input.val('').change();
  f_input.removeClass('is-valid');
  $('input[name="case[case_attachments_attributes][' + t + '][file_cache]').val('').change();
  $('.file-label-' + t).text('選擇檔案');
}
function validate_form(){
  $.validator.addMethod('addrCheck', function(value, element, params) {
    var a1 = $('input[name="case[addr1]"]').val();
    var a2 = $('input[name="case[addr2]"]').val();
    var a3 = $('input[name="case[addr3]"]').val();
    var a4 = $('input[name="case[addr4]"]').val();
    var a5 = $('input[name="case[addr5]"]').val();
    var a6 = $('input[name="case[addr_detail]"]').val();
    return !(isEmpty(a1) && isEmpty(a2) && isEmpty(a3) && isEmpty(a4) && isEmpty(a5) && isEmpty(a6));
  }, "巷、弄、號、之號、KM，及地點備註，至少要填其中一個");

  $.validator.addMethod('totalCheck', function(value, element, params) {
    sum = Filevalidation();
    return sum >= 0 && sum <= 85;
  }, "上傳檔案之檔案大小總和已超出範圍限制");

  $.validator.addMethod('illegality_check', function (value, element, param) {
    return !($('#case_illegality_code').val() == 13 && isEmpty(value));
  }, '請填寫違規明細');

  $.validator.addMethod('filesize', function (value, element, param) {
    if(element.files.length > 0){
      var fs = element.files[0].size  / Math.pow(1024,2);
      return (fs <= param && element.files[0].size >= 1000)
    }else{
      return true
    }
  }, '單個檔案必須小於 {0} MB，並大於 1 KB');

  $.validator.addMethod(
    "regex",
    function(value, element, regexp) {
        var re = new RegExp(regexp);
        return this.optional(element) || re.test(value);
    }, "格式不正確"
  );


  $( "form" ).validate( {
    focusInvalid: false,
    invalidHandler: function() {
      $(this).find(".is-invalid:first").focus();
    },
    rules: {
      "case[name]":{
        required: true,
        regex: /^[\u4E00-\u9FA5]+$/,
        maxlength: 10
      },

      "case[id_number]":{
        required: true,
        regex: /^[a-zA-Z][0-9]{9}$/,
      },

      "case[contact_address]":{
        required: true,
        minlength: 10,
        maxlength:50
      },

      "case[phone]":{
        required: true,
        maxlength: 15,
        regex: /^[0-9\-\#]*$/,
      },

      "case[addr1]":{
        required: false,
        digits: true,
      },

      "case[addr2]":{
        required: false,
        digits: true,
      },

      "case[addr3]":{
        required: false,
        digits: true,
      },

      "case[addr4]":{
        required: false,
        digits: true,
      },

      "case[addr5]":{
        required: false,
        digits: true,
      },
      "case[addr_detail]":{
        required: false,
        maxlength: 50,
        addrCheck: []
      },

      "case[violated_at_date]":{
        required: true
      },
      "case[violated_at_hour]":{
        required: true
      },

      "case[violated_at_min]":{
        required: true
      },

      "case[car_type_code]":{
        required: true
      },

      "case[area_district]":{
        required: true
      },
      "case[area_code]":{
        required: true
      },
      "case[first_car_number]":{
        required: true,
        regex: /^[0-9a-zA-Z]+$/,
        minlength: 2,
        maxlength: 4
      },

      "case[last_car_number]":{
        required: true,
        regex: /^[0-9a-zA-Z]+$/,
        minlength: 2,
        maxlength: 4
      },
      "case[illegality_code]":{
        required: true
      },

      "case[category_name]":{
        required: true
      },


      "case[illegality_details]":{
        illegality_check: true,
        maxlength: 100
      },


      "case[email]": {
        email: true,
      },
      "case[case_attachments_attributes][4][file]": {
        totalCheck: [],
        zeroCheck: []
      },
    },
    messages: {
      // "case[email]": {remote: "請先驗證Email地址"}
      "case[name]": {regex: '請填寫真實中文姓名'},
      "case[id_number]": {regex: '請輸入真實身份證格式'},
      "case[last_car_number]": {regex: '請輸入英文或數字'},
      "case[first_car_number]": {regex: '請輸入英文或數字'},
    },
    errorElement: "div",
    errorPlacement: function ( error, element ) {
      error.addClass( "invalid-feedback d-block" );

      if ( element.prop( "type" ) === "checkbox" ) {
        error.insertAfter( element.parent( "label" ) );
      }else if(element.next().hasClass('input-group-append')){
        error.appendTo(element.parent());
      }else {
        error.insertAfter( element );
      }
    },
    highlight: function ( element, errorClass, validClass ) {

      if($(element).attr("type") == 'file' && $(element)[0].files.length == 0){
      }else if($(element).hasClass('select2')){
        $(element).siblings('.select2-container').find(".select2-selection").addClass('is-invalid').removeClass('is-valid');
      }else{
        $( element ).addClass( "is-invalid" ).removeClass( "is-valid" );
      }

    },
    unhighlight: function (element, errorClass, validClass) {
      if($(element).attr("type") == 'file' && $(element)[0].files.length == 0){
      }else if($(element).hasClass('select2')){
        $(element).siblings('.select2-container').find(".select2-selection").addClass( "is-valid" ).removeClass( "is-invalid" );
      }else{
        $( element ).addClass( "is-valid" ).removeClass( "is-invalid" );
      }

    }
  });

  $('input[name^="case[case_attachments_attributes]"]').each(function () {
    $(this).rules('add', {
        required: false,
        filesize: 85
    })
  });
}
function preview(){
  var valid = $('form').valid();
  if(valid){

    $('#case_preview').html("<div class=\"modal-dialog\">\n  <div class=\"modal-content\">\n    <div class=\"modal-header\">\n      <h2 class=\"modal-title\">案件預覽<\/h2>\n      <button type=\"button\" class=\"close\" data-dismiss=\"modal\">&times;<\/button>\n    <\/div>\n\n    <!-- Modal body -->\n    <div class=\"modal-body\">\n      <h2>檢舉人資料<\/h2>\n      <dl class=\"row\">\n\n\n          <dt class=\"col-sm-4\">Email<\/dt>\n          <dd class=\"col-sm-8\" data-name=\"case[email]\">\n\n          <\/dd>\n\n          <dt class=\"col-sm-4\">檢舉人姓名<\/dt>\n          <dd class=\"col-sm-8\" data-name=\"case[name]\">\n\n          <\/dd>\n\n          <dt class=\"col-sm-4\">身分證字號<\/dt>\n          <dd class=\"col-sm-8\" data-name=\"case[id_number]\">\n\n          <\/dd>\n\n          <dt class=\"col-sm-4\">聯絡地址<\/dt>\n          <dd class=\"col-sm-8\" data-name=\"case[contact_address]\">\n\n          <\/dd>\n\n          <dt class=\"col-sm-4\">聯絡電話<\/dt>\n          <dd class=\"col-sm-8\" data-name=\"case[phone]\">\n\n          <\/dd>\n\n          <dt class=\"col-sm-4\">檢舉日期／時間<\/dt>\n          <dd class=\"col-sm-8\" data-name=\"case[created_at]\">\n\n          <\/dd>\n      <\/dl>\n\n      <h2>檢舉內容<\/h2>\n      <dl class=\"row\">\n          <dt class=\"col-sm-4\">違規日期／時間<\/dt>\n          <dd class=\"col-sm-8\"  data-name=\"case[violated_at]\">\n\n          <\/dd>\n          <dt class=\"col-sm-4\">違規車號<\/dt>\n          <dd class=\"col-sm-8\"  data-name=\"case[car_number]\">\n\n          <\/dd>\n          <dt class=\"col-sm-4\">違規地點<\/dt>\n          <dd class=\"col-sm-8\"  data-name=\"case[full_address]\">\n\n          <\/dd>\n          <dt class=\"col-sm-4\">違規事實<\/dt>\n          <dd class=\"col-sm-8\"  data-name=\"case[illegality_name]\">\n\n          <\/dd>\n\n\n        <dt class=\"col-sm-4 illegality_details\" style=\"display: none;\">違規事實說明<\/dt>\n            <dd class=\"col-sm-8 illegality_details\" style=\"display: none;\"  data-name=\"case[illegality_details]\">\n        <\/dl>\n      <h2>檔案上傳<\/h2>\n      <div class=\"attachments\">\n          <p id=\"attachment_0\"><\/p>\n          <p id=\"attachment_1\"><\/p>\n          <p id=\"attachment_2\"><\/p>\n          <p id=\"attachment_3\"><\/p>\n          <p id=\"attachment_4\"><\/p>\n          <p id=\"attachment_5\"><\/p>\n      <\/div>\n    <\/div>\n\n    <!-- Modal footer -->\n    <div class=\"modal-footer\">\n       <!--<button type=\"button\" class=\"btn btn-primary submit-form\" onclick=\"submit_form()\">確認>送出<\/button>-->\n            <button type=\"button\" class=\"btn btn-primary submit-form\" onclick=\"submit_form()\">確認送出<\/button>\n      <button type=\"button\" class=\"btn btn-danger edit-form-btn\" data-dismiss=\"modal\">繼續編輯<\/button>\n    <\/div>\n\n  <\/div>\n<\/div>\n")
    var formData = $('form').serializeArray();
    var namespace = "cases"
    if(namespace != 'admin'){
      formData.push({name: 'case[violated_at]', value: get_violated_at()});
      formData.push({name: 'case[created_at]', value: get_created_at()});
    }

    formData.push({name: 'case[car_number]', value: get_car_number()});
    formData.push({name: 'case[full_address]', value: get_address()});
    if(!isEmpty($('#case_illegality_code option:selected').val())){
      formData.push({name: 'case[illegality_name]', value: $('#case_illegality_code option:selected').text()});
    }

    if(!isEmpty($('#case_illegality_details').val())){
      formData.push({name: 'case[illegality_details]', value: $('#case_illegality_details').val()});
      $('.illegality_details').show();
    }else{
      $('.illegality_details').hide();
    }


    $('.case_attachment_input').each(function(i){
      if($(this)[0] && $(this)[0].files[0]){
        var fi = $(this)[0]
        var totalSize = fi.files[0].size;
        var mb = (totalSize / Math.pow(1024,2)).toFixed(1)
        $("#attachment_" + i).append(fi.files[0].name + "&nbsp;&nbsp;&nbsp;&nbsp;" + mb + "MB")
      }else if($(this).siblings('.case_attachment_cache').data('file-size') > 0){
        var cache = $(this).siblings('.case_attachment_cache')
        var s1 = cache.data('file-size')
        var mb = (s1 / Math.pow(1024,2)).toFixed(1)
        $("#attachment_" + i).append(cache.data('file-name') + "&nbsp;&nbsp;&nbsp;&nbsp;" + mb + "MB")
      }
    });

    $('.attachments').append("檔案大小總和: " + Filevalidation() + "MB")


    $.each(formData, function(i, e){
      $("#case_preview [data-name='" + e.name + "']").text(e.value);
    })

    if( $('#email_chk').val() != "1" ) {
        alert('信箱尚未通過驗證!');
        $('#case_preview').modal('hide');
           } else {
    $('#case_preview').modal('show')
           }

    $('.submit-form').click(function(){
      $('.case_submit').click();
      if(!$("form").valid()){
        $('#case_preview').modal('hide');
      };
    })
  }else{
    $('form').find(".is-invalid:first").focus();
  }
}


function readURL(input, target) {
  if (input.files && input.files[0]) {
    var reader = new FileReader();
    reader.onload = function (e) {
      target.append('<img src="' + e.target.result + '">');
    }
    reader.readAsDataURL(input.files[0]);
  }
}

function submit_form(){
//alert('檢舉系統維護中!');
  //$('#case_preview').modal('hide');
  $('.submit-form').attr('disabled', 'disabled').html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>正在送出中，請勿關閉...');
  $('.edit-form-btn').attr('disabled', 'disabled');
  $('.edit-form-btn').addClass('disabled');
  //$('.case_submit').click();
  $('.case_submit').bind("click",function(){
          setTimeout(function(){
                  window.location.href = 'cases_w.php';
          }, 3000);
  });

}



function get_violated_at(){
  return $('#case_violated_at').val()
}

function get_created_at(){
  return $('#case_created_at').val()
}

function get_car_number(){
  return $('#case_car_type_code option:selected').text() + ' ' + $('#case_first_car_number').val().toUpperCase() + '-' + $('#case_last_car_number').val().toUpperCase()
}

function get_address(){
  var s = $('#case_area_district option:selected').text() +  $('#case_area_code option:selected').text()

  if(!isEmpty($('#case_addr1').val())){
    s += $('#case_addr1').val() + '巷'
  }

  if(!isEmpty($('#case_addr2').val())){
    s += $('#case_addr2').val() + '弄'
  }

  if(!isEmpty($('#case_addr3').val())){
    s += $('#case_addr3').val() + '號'
  }

  if(!isEmpty($('#case_addr4').val())){
    s += "之" + $('#case_addr4').val()
  }
  if(!isEmpty($('#case_addr5').val())){
    s += "  " + $('#case_addr5').val() + '公里'
  }

  if(!isEmpty($('#case_addr_detail').val())){
    s += " (" + $('#case_addr_detail').val() + ")"
  }

  return s
}
function assign_attrs(){
  var attrs = jQuery.parseJSON('{"id":null,"email":null,"name":null,"id_number":null,"contact_address":null,"phone":null,"created_at":null,"updated_at":null,"addr1":null,"addr2":null,"addr3":null,"addr4":null,"addr5":null,"area_code":null,"illegality_code":null,"illegality_details":null,"car_type_code":null,"first_car_number":null,"last_car_number":null,"sn":null,"area_district":null,"addr_detail":null,"violated_at":null,"real_ip":null,"read_statement":null,"state":"ready","department_id":null,"approve_admin_user_id":null,"review_admin_user_id":null,"recheck_admin_user_id":null,"finish_admin_user_id":null,"expose":false,"expose_reason_code":null,"unexpose_reason_id":null,"unexpose_reason_note":null,"fake":false,"full_car_number":null,"finished_date":null,"comment":null,"reassign_count":0,"category_name":null,"created_admin_user_id":null,"violated_at_date":null,"violated_at_hour":null,"violated_at_min":null}')
  $.each(attrs,function(name,value) {
    if(!isEmpty(value)){
      $('[name="case[' + name + ']"]').val(value).change();
    }
  });
  if(!isEmpty(attrs.area_district)){
    $('[name="case[' + "area_district" + ']"]').val(attrs.area_district).change();
    $('[name="case[' + "area_code" + ']"]').val(attrs.area_code).change();
  }




}

function isEmpty(value) {
  return typeof value == 'string' && !value.trim() || typeof value == 'undefined' || value === null;
}

function check_to_hide_or_show_add_link() {
  if ($('.nested-fields').length >= 5) {
    $('.add-attachment-btn').hide();
  } else {
    $('.add-attachment-btn').show();
  }
}

function Filevalidation(){
  var sum = 0;
  $('.case_attachment_input').each(function(i){
    if($(this)[0] && $(this)[0].files[0]){
      var fi = $(this)[0]
      var totalSize = fi.files[0].size;
      sum += totalSize
    }else if($(this).siblings('.case_attachment_cache').data('file-size') > 0){
      var cache = $(this).siblings('.case_attachment_cache')
      var s1 = cache.data('file-size')
      sum += s1
    }
  })
  total = (parseFloat(sum)  / Math.pow(1024,2)).toFixed(1)
  $('.filesize').text(total);
  return total;
}

  </script>

  </body>



</html>

